# Workspace Integrity

In order to reduce to prevent the server from partially leaving out data a hash is created based on the current workspace state and then signed by the author.

It locks down the following data:

- clock
- workspaceInfo
- folder tree
- user chains

The purpose of the clock is to make sure the server can only provide newer workspace integrity proofs, but never older ones.

## Cryptographic Dependencies and actual implementation

- hash: `sodium.to_base64(sodium.crypto_generichash(64, message))`
- sign: `sodium.crypto_sign_detached(message, privateKey)`
- signVerify: `sodium.crypto_sign_detached(signature, message, publicKey)`

## Workspace Integrity Data

```ts
clock: number;
workspaceInfoCiphertext: string;
workspaceInfoNonce: string;
folderTreeRootHash: string;
workspaceChainHash: string;
userChainHashes: record<userId, lastUserChainEventHash>;
```

## Creating a workspace integrity proof

```ts
workspaceIntegrityDataString = canonicalize(workspaceIntegrityData);
workspaceIntegrityHash = hash(workspaceIntegrityDataString);
workspaceIntegrityHashSignature = sign(
  "workspace_integrity_proof" + workspaceIntegrityHash,
  deviceSigningPrivateKey
);
```

https://github.com/serenity-kit/Serenity/blob/main/packages/workspace-integrity/src/createWorkspaceIntegrityProof.ts#L11-L41

## Checking for the integrity of workspace data

```ts
workspaceIntegrityDataString = canonicalize(workspaceIntegrityData);
workspaceIntegrityHash = hash(workspaceIntegrityDataString);
assert(workspaceIntegrityHash === existingWorkspaceIntegrityHash);
signVerify(
  workspaceIntegrityHashSignature,
  workspaceIntegrityHash,
  authorDeviceSigningPublicKey
);
```

https://github.com/serenity-kit/Serenity/blob/main/packages/workspace-integrity/src/isValidWorkspaceIntegrityProof.ts

## Version Checks

Each Workspace Integrity Proof is associated with a version. Is the version higher than what the current client is aware of the client will throw an error and the user must be informed to update the application.

## App Integration

TODO Currently not yet integrated.
