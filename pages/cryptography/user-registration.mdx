## Registration Process

Password-strength is enforced by the client -> TODO

## Cryptographic Dependencies and actual implementation

- opaque_registration: OPAQUE registration flow
- kdf: `sodium.crypto_kdf_derive_from_key(crypto_aead_xchacha20poly1305_ietf_KEYBYTES, subkeyId, context, key)`
- noncegen: `sodium.randombytes_buf(sodium.crypto_secretbox_NONCEBYTES)`
- signingKeyPairGen: `sodium.crypto_sign_keypair()`
- encryptionKeyPairGen: `sodium.crypto_box_keypair()`
- sign: `sodium.crypto_sign_detached(message, privateKey)`
- encrypt: `sodium.crypto_secretbox_easy(message, nonce, key)`
- createUserChain: see user-chain

### Steps

```ts
exportKey = opaque_registration();
encryptionKey = kdf(1111, "m_device", exportKey);
nonce = noncegen();
// create device
deviceSigningKeyPair = signingKeyPairGen();
deviceEncryptionKeyPair = encryptionKeyPairGen();
deviceEncryptionPublicKeySignature = sign(
  "user_device_encryption_public_key" + deviceEncryptionKeyPair.publicKey,
  deviceSigningKeyPair.privateKey
);
ciphertext = encrypt(
  {
    signingPublicKey,
    signingPrivateKey,
    encryptionPublicKey,
    encryptionPrivateKey,
    encryptionPublicKeySignature,
    createdAt,
  },
  nonce,
  encryptionKey
);
```

The following information is sent to the server:

```ts
{
  registrationRecord, // OPAQUE registration record
  mainDevice: { // TODO duplicate as this information should be included in the serializedUserChainEvent
    signingPublicKey,
    encryptionPublicKey,
    encryptionPublicKeySignature,
  },
  serializedUserChainEvent,
}
```

https://github.com/serenity-kit/Serenity/blob/main/apps/app/components/register/RegisterForm.tsx#L85-L193

https://github.com/serenity-kit/Serenity/blob/main/packages/common/src/createAndEncryptMainDevice/createAndEncryptMainDevice.ts

The server stores this information in the database in the `UnverifiedUser` table and triggers an email with a verification code.

On the client side the `username`, `password` and `createChainEvent` are stored in memory.

https://github.com/serenity-kit/Serenity/blob/main/apps/app/components/register/RegisterForm.tsx#L166C11-L170

https://github.com/serenity-kit/Serenity/blob/main/apps/app/utils/authentication/registrationMemoryStore.ts

After that client is redirecting to the registration verification page.

https://github.com/serenity-kit/Serenity/blob/main/apps/app/navigation/screens/registrationVerificationScreen/RegistrationVerificationScreen.tsx

The user enters the verification code and submits the form. The server checks the code and if it is valid, it creates a new `User` record in the database and the user finished the registration process.

// TODO accept pending workspace invitations

// TODO explain the goals of this flow & process

## Registration via Invitation

-> registration memory store

# Workspace Invitation

https://github.com/serenity-kit/Serenity/blob/main/packages/common/src/encryptWorkspaceInvitationKey/encryptWorkspaceInvitationKey.ts

https://github.com/serenity-kit/Serenity/blob/main/packages/common/src/decryptWorkspaceInvitationKey/decryptWorkspaceInvitationKey.ts
